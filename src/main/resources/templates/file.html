<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <link rel="stylesheet" th:href="@{/static/css/main.css}" href="/static/css/main.css"/>
    <link rel="stylesheet" th:href="@{/static/layui/css/layui.css}" href="/static/layui/css/layui.css"/>
    <style>

    </style>
</head>
<body>
<div id="app">
    <!--  菜单  -->
    <div th:include="header :: common"></div>

    <div class="self-body">
        <div class="layui-card">
            <div class="layui-card-header"
                 style="height: 50px !important;padding-top: 10px !important;background-color: #f5f5f5">
                <div class="layui-form-item">

                    <div class="layui-inline">
                        <div class="layui-input-inline" style="width: 180px;">
                            <input type="text" name="price_min" placeholder="请输入文件名" autocomplete="off"
                                   class="layui-input">
                        </div>
                    </div>

                    <div class="layui-inline" style="float: right">
                        <button class="layui-btn layui-btn-primary" id="demo4">
                            工具
                            <i class="layui-icon layui-icon-more-vertical layui-font-12"></i>
                        </button>
                    </div>
                </div>

            </div>
            <div class="layui-card-body" style="min-height: 200px">
                <div>
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                        <legend>拖拽上传</legend>
                    </fieldset>

                    <div style="width: 100%;text-align:center;">
                        <div class="layui-upload-drag" id="upload" style="width: 80%">
                            <i class="layui-icon"></i>
                            <p>点击上传，或将文件拖拽到此处</p>
                        </div>
                    </div>

                </div>

            </div>

            <!--   文件列表     -->
            <div>

                <table class="layui-hide" id="fileTable" lay-filter="test"></table>

            </div>
        </div>
    </div>


</div>

</body>
<script th:src="@{/static/layui/layui.js}" src="/static/layui/layui.js" type="text/javascript"></script>
<script th:src="@{/static/js/main.js}" th:inline="none" type="text/javascript"></script>

<!--操作-->
<script type="text/html" th:inline="none" id="barDemo">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">预览</a>
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>


<script type="text/javascript" th:inline="none">

    $(function (){
        setActive("file");
    })

    //拖拽上传
    upload.render({
        elem: '#upload'
        , accept: 'file' //普通文件
        , choose: obj => {
            // 清空历史上传文件，解决choose只执行一次的问题！！！
            //upload.config.elem.next()[0].value = '';
        }
        , url: '/file/upload'
        , done: function (res) {
            return layer.msg('上传成功');
        },
        error: function (e) {
            console.log(e)
            return layer.msg('上传失败');
        }


    });



    table.render({
        elem: '#fileTable'
        , url: '/file/searchFolder'
        , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
        , cols: [[
            {
                title: '', fixed: 'left', width: '5%', align: 'center', templet: function (d) {
                    let html = '';
                    if (d.type === 1) {
                        html += '<span class="layui-badge-dot layui-bg-green"></span>';
                    } else if (d.type === 2) {
                        html += '<span class="layui-badge-dot layui-bg-blue"></span>';
                    }
                    return html;
                }, unresize: true
            },

            //{title: '类型', fixed: 'left', width: '10%', align: 'center', toolbar: '#barDemo'},
            {field: 'fileName', width: '25%', title: '文件名'},
            {field: 'createTime', width: '20%', title: '创建日期'},
            {field: 'fileSize', width: '15%', title: '大小'},
            {field: 'createName', width: '15%', title: '创建者'},
            {width: '20%', title: '操作', align: 'center', toolbar: '#barDemo'}
        ]],
        // response: {
        //     statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
        // }
    });


    table.on('tool(test)', function (obj) {//test为table标签中lay-filter的值

        let data = obj.data;

        if (obj.event === 'del') {
            removeFile(data)
        }else if (obj.event === 'detail') {
            if(data.fileName.indexOf(".pdf") !== -1){
                viewFile(data)
            }else if(data.fileName.indexOf(".jpg") !== -1){
                layer.photos({ photos: {"data": [{"src": "/file/view?filePath=" + data.filePath + "\\" + data.fileName}]} ,closeBtn:true});
            }

        }
    });



    //自定义事件 - hover
    dropdown.render({
        elem: '#demo4'
        , trigger: 'hover'
        , data: [{
            title: '上传文件'
            , id: 100
        }, {
            title: '上传文件夹'
            , id: 101
        }, {
            title: '新建文件夹'
            , id: 102
        },
            {
                title: '复制'
                , id: 103
            },
            {
                title: '剪切'
                , id: 104
            },
            {
                title: '删除'
                , id: 105
            }],
        //菜单被点击的事件
        click: function (obj) {
            console.log(obj);
            //prompt层
            if (obj.id === 102) {
                layer.prompt({title: '请输入新建的文件夹名称', formType: 3}, function (text, index) {
                    layer.close(index);
                    //text
                    createDirectory(text)
                });
            }

        }
    });


    function createDirectory(name) {
        $.get("/file/createDirectory", {'directoryName': name},
            function (dat) {
                layer.msg(dat.message);
            });
    }


    function removeFile(file) {
        $.ajax({
            type: "post",
            url: "/file/removeFile",
            contentType: "application/json",
            data: JSON.stringify(file),
            dataType: "json",
            success: function (data) {
                alert(data.message);
            },
            error: function (msg) {
                console.log(msg)
            }
        })
    }

    function viewFile(data) {
        window.open("/static/js/web/viewer.html?file=/file/view?filePath=" + data.filePath + "\\" + data.fileName);
    }



</script>


</html>

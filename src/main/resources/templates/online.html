<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>online</title>
    <link rel="stylesheet" th:href="@{/static/css/main.css}" href="/static/css/main.css"/>
    <link rel="stylesheet" th:href="@{/static/layui/css/layui.css}" href="/static/layui/css/layui.css"/>
    <style>

    </style>
</head>
<body>
<div id="app">
    <!--  菜单  -->
    <div th:include="header :: common"></div>

    <div class="self-body">

        <div>
            <table class="layui-hide" id="fileTable" lay-filter="test"></table>
        </div>

    </div>


</div>

</body>
<script th:src="@{/static/libs/jquery-3.2.1.min.js}" src="/static/libs/jquery-3.2.1.min.js"
        type="text/javascript"></script>
<script th:src="@{/static/layui/layui.js}" src="/static/layui/layui.js" type="text/javascript"></script>
<script th:src="@{/static/js/main.js}" th:inline="none" type="text/javascript"></script>


<!--<script type="text/javascript">-->
<!--    const folderPath = [[${folderPath}]];-->
<!--</script>-->
<script type="text/javascript" th:inline="none">

    $(function () {
        setActive("info");
        $.get("/server/ip",
            function (dat) {
                openSocket(dat.message);
            });
        // js
        // window.onbeforeunload = function(){
        //     if(socket != null){
        //         socket.close();
        //     }
        //     return "";
        // }
    })

    let socket;

    function openSocket(ip) {

        if (typeof (WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        } else {
            console.log("您的浏览器支持WebSocket");
            //实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接
            //等同于socket = new WebSocket("ws://localhost:8888/xxxx/im/25");
            //var socketUrl="${request.contextPath}/im/"+$("#userId").val();
            let socketUrl = getRealPath() + "/websocket?token=" + ip;
            socketUrl = socketUrl.replace("https", "ws").replace("http", "ws");
            console.log(socketUrl);
            if (socket != null) {
                socket.close();
                socket = null;
            }
            socket = new WebSocket(socketUrl);
            //打开事件
            socket.onopen = function () {
                console.log("websocket已打开");
                socket.send("这是来自客户端的消息" + new Date());
            };
            //获得消息事件
            socket.onmessage = function (msg) {
                console.log(msg.data);
                //发现消息进入    开始处理前端触发逻辑
            };
            //关闭事件
            socket.onclose = function () {
                console.log("websocket已关闭");
            };
            //发生了错误事件
            socket.onerror = function () {
                console.log("websocket发生了错误");
            }
        }
    }


    const tableIndex = table.render({
        elem: '#fileTable'
        , url: '/server/online'
        , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
        , cols: [[
            {field: 'ip', width: '40%', title: 'ip'},
            {field: 'lastLoginTime', width: '60%', title: '最近一次登录时间'},
        ]],
        // response: {
        //     statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
        // }
    });


</script>


</html>
